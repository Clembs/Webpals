<script lang="ts">
	import { enhance } from '$app/forms';
	import Button from '$lib/components/Button.svelte';
	import TextInput from '$lib/components/TextInput.svelte';
	import { validateFileSignatures, type MimeTypes } from '$lib/helpers/files';
	import MusicWidgetComponent from '$lib/widgets/default/MusicWidgetComponent.svelte';
	import type { MusicWidget, WidgetComponentProps } from '$lib/widgets/types';
	import { parseWebStream } from 'music-metadata';
	import { slide } from 'svelte/transition';

	let {
		modalOpened = $bindable(),
		widget
	}: WidgetComponentProps<MusicWidget> & {
		modalOpened: boolean;
	} = $props();

	let widgetTitle = $state(widget.title || '');
	let widgetArtist = $state(widget.artist || '');
	let widgetContentUrl = $state(widget.content_url);
	let widgetProvider = $state(widget.provider);

	let isNewMusic = $state(widget.provider !== 'local');
	let isLoading = $state(false);
	let error = $state('');

	const mimeTypes: MimeTypes[] = [
		'audio/mpeg',
		'audio/wav',
		'audio/flac',
		// 'audio/ogg',
		'audio/x-wav'
	];

	let isDragging = $state(false);
	let files = $state<FileList | null | undefined>(null);

	async function handleFilesChange() {
		error = '';
		const file = files?.[0];

		// When the file is loaded, check its MIME type
		if (!file || !file.type.startsWith('audio/')) {
			error = 'Invalid file type.';
			return;
		}

		// check the file signature to be extra sure
		const isValidMimeSignature = await validateFileSignatures(file, mimeTypes);

		if (!isValidMimeSignature) {
			error = 'Invalid file type.';
			return;
		}

		// check if the file is too large (>3MB)
		if (file.size > 3 * 1024 * 1024) {
			error = 'File must be less than 3 MB in size.';
			return;
		}

		// check if the music's duration is above 10 minutes
		const metadata = await parseWebStream(file.stream());

		if (metadata.format?.duration && metadata.format.duration > 600) {
			error = 'Music must be less than 10 minutes in duration.';
			return;
		}

		widgetContentUrl = URL.createObjectURL(file);
		widgetProvider = 'local';

		widgetTitle = metadata.common?.title || file.name;
		widgetArtist = metadata.common?.artist || 'Unknown';
	}
</script>

<form
	use:enhance={() => {
		isLoading = true;
		return async ({ result, update }) => {
			await update({ reset: false, invalidateAll: true });
			isLoading = false;

			if (result.type === 'success') {
				modalOpened = false;
			} else if (result.type === 'failure' && typeof result.data?.message === 'string') {
				error = result.data.message;
			}
		};
	}}
	action="/api/profile?/setLocalMusic"
	method="post"
	enctype="multipart/form-data"
>
	<input
		type="file"
		accept={mimeTypes.join(', ')}
		id="audio-file-upload"
		name="audio-file"
		bind:files
		onchange={async (e) => {
			e.preventDefault();

			handleFilesChange();
		}}
	/>

	<!-- If the user hasn't set anything, show the "drag file to upload" menu -->
	{#if widgetProvider !== 'local' || !widgetContentUrl}
		<!-- TODO: support drag n' drop -->
		<label
			for="audio-file-upload"
			ondragenter={(e) => {
				e.preventDefault();
				isDragging = true;
			}}
			ondragover={(e) => {
				e.preventDefault();
				isDragging = true;
			}}
			ondragleave={(e) => {
				e.preventDefault();
				isDragging = false;
			}}
			ondragexit={(e) => {
				e.preventDefault();
				isDragging = false;
			}}
			ondrop={(e) => {
				e.preventDefault();
				files = e.dataTransfer?.files;
				handleFilesChange();

				isDragging = false;
			}}
			class:dragging={isDragging}
		>
			<span class="heading">
				<svg
					width="155"
					height="54"
					viewBox="0 0 155 54"
					fill="none"
					xmlns="http://www.w3.org/2000/svg"
				>
					<path
						fill-rule="evenodd"
						clip-rule="evenodd"
						d="M32.9916 4.81912C33.226 4.5847 33.544 4.453 33.8755 4.453C34.207 4.453 34.525 4.5847 34.7594 4.81912C34.9938 5.05354 35.1255 5.37148 35.1255 5.703V35.703C35.1255 36.0345 34.9938 36.3525 34.7594 36.5869C34.525 36.8213 34.207 36.953 33.8755 36.953C33.544 36.953 33.226 36.8213 32.9916 36.5869C32.7572 36.3525 32.6255 36.0345 32.6255 35.703V5.703C32.6255 5.37148 32.7572 5.05354 32.9916 4.81912ZM39.2416 9.81912C39.476 9.5847 39.794 9.453 40.1255 9.453C40.457 9.453 40.775 9.5847 41.0094 9.81912C41.2438 10.0535 41.3755 10.3715 41.3755 10.703V30.703C41.3755 31.0345 41.2438 31.3525 41.0094 31.5869C40.775 31.8213 40.457 31.953 40.1255 31.953C39.794 31.953 39.476 31.8213 39.2416 31.5869C39.0072 31.3525 38.8755 31.0345 38.8755 30.703V10.703C38.8755 10.3715 39.0072 10.0535 39.2416 9.81912ZM45.4916 14.8191C45.726 14.5847 46.044 14.453 46.3755 14.453C46.707 14.453 47.025 14.5847 47.2594 14.8191C47.4938 15.0535 47.6255 15.3715 47.6255 15.703V25.703C47.6255 26.0345 47.4938 26.3525 47.2594 26.5869C47.025 26.8213 46.707 26.953 46.3755 26.953C46.044 26.953 45.726 26.8213 45.4916 26.5869C45.2572 26.3525 45.1255 26.0345 45.1255 25.703V15.703C45.1255 15.3715 45.2572 15.0535 45.4916 14.8191ZM51.7416 12.3191C51.976 12.0847 52.294 11.953 52.6255 11.953C52.957 11.953 53.275 12.0847 53.5094 12.3191C53.7438 12.5535 53.8755 12.8715 53.8755 13.203V28.203C53.8755 28.5345 53.7438 28.8525 53.5094 29.0869C53.275 29.3213 52.957 29.453 52.6255 29.453C52.294 29.453 51.976 29.3213 51.7416 29.0869C51.5072 28.8525 51.3755 28.5345 51.3755 28.203V13.203C51.3755 12.8715 51.5072 12.5535 51.7416 12.3191ZM25.8755 26.25V16.25C25.8755 15.9185 26.0072 15.6005 26.2416 15.3661C26.476 15.1317 26.794 15 27.1255 15C27.457 15 27.775 15.1317 28.0094 15.3661C28.2438 15.6005 28.3755 15.9185 28.3755 16.25V26.25C28.3755 26.5815 28.2438 26.8995 28.0094 27.1339C27.775 27.3683 27.457 27.5 27.1255 27.5C26.794 27.5 26.476 27.3683 26.2416 27.1339C26.0072 26.8995 25.8755 26.5815 25.8755 26.25ZM21.7594 5.36612C21.525 5.1317 21.207 5 20.8755 5C20.544 5 20.226 5.1317 19.9916 5.36612C19.7572 5.60054 19.6255 5.91848 19.6255 6.25V36.25C19.6255 36.5815 19.7572 36.8995 19.9916 37.1339C20.226 37.3683 20.544 37.5 20.8755 37.5C21.207 37.5 21.525 37.3683 21.7594 37.1339C21.9938 36.8995 22.1255 36.5815 22.1255 36.25V6.25C22.1255 5.91848 21.9938 5.60054 21.7594 5.36612ZM15.5094 10.3661C15.275 10.1317 14.957 10 14.6255 10C14.294 10 13.976 10.1317 13.7416 10.3661C13.5072 10.6005 13.3755 10.9185 13.3755 11.25V31.25C13.3755 31.5815 13.5072 31.8995 13.7416 32.1339C13.976 32.3683 14.294 32.5 14.6255 32.5C14.957 32.5 15.275 32.3683 15.5094 32.1339C15.7438 31.8995 15.8755 31.5815 15.8755 31.25V11.25C15.8755 10.9185 15.7438 10.6005 15.5094 10.3661ZM9.25937 15.3661C9.02495 15.1317 8.70701 15 8.37549 15C8.04397 15 7.72602 15.1317 7.4916 15.3661C7.25718 15.6005 7.12549 15.9185 7.12549 16.25V26.25C7.12549 26.5815 7.25718 26.8995 7.4916 27.1339C7.72602 27.3683 8.04397 27.5 8.37549 27.5C8.70701 27.5 9.02495 27.3683 9.25937 27.1339C9.49379 26.8995 9.62549 26.5815 9.62549 26.25V16.25C9.62549 15.9185 9.49379 15.6005 9.25937 15.3661ZM3.00937 12.8661C2.77495 12.6317 2.45701 12.5 2.12549 12.5C1.79397 12.5 1.47602 12.6317 1.2416 12.8661C1.00718 13.1005 0.875488 13.4185 0.875488 13.75V28.75C0.875488 29.0815 1.00718 29.3995 1.2416 29.6339C1.47602 29.8683 1.79397 30 2.12549 30C2.45701 30 2.77495 29.8683 3.00937 29.6339C3.24379 29.3995 3.37549 29.0815 3.37549 28.75V13.75C3.37549 13.4185 3.24379 13.1005 3.00937 12.8661Z"
						fill="var(--color-paragraph)"
					/>
					<path
						d="M82.1255 28.7968C82.1242 29.8993 81.8353 30.9824 81.2872 31.939C80.7391 32.8956 79.9509 33.6927 79.0005 34.2514C78.7159 34.3932 78.3879 34.4211 78.0835 34.3295C77.779 34.238 77.5208 34.0339 77.3615 33.7587C77.2023 33.4835 77.1538 33.158 77.2261 32.8484C77.2983 32.5388 77.4859 32.2683 77.7505 32.0921C78.3236 31.7538 78.7985 31.2719 79.1284 30.694C79.4584 30.1162 79.6319 29.4622 79.6319 28.7968C79.6319 28.1313 79.4584 27.4774 79.1284 26.8995C78.7985 26.3216 78.3236 25.8397 77.7505 25.5014C77.4859 25.3252 77.2983 25.0548 77.2261 24.7451C77.1538 24.4355 77.2023 24.11 77.3615 23.8348C77.5208 23.5596 77.779 23.3555 78.0835 23.264C78.3879 23.1724 78.7159 23.2004 79.0005 23.3421C79.9509 23.9008 80.7391 24.6979 81.2872 25.6545C81.8353 26.6112 82.1242 27.6942 82.1255 28.7968ZM73.8536 20.7671C73.6252 20.6723 73.3739 20.6474 73.1314 20.6955C72.8888 20.7437 72.666 20.8626 72.4911 21.0374L69.1083 24.4218H65.8755C65.544 24.4218 65.226 24.5534 64.9916 24.7879C64.7572 25.0223 64.6255 25.3402 64.6255 25.6718V31.9218C64.6255 32.2533 64.7572 32.5712 64.9916 32.8056C65.226 33.0401 65.544 33.1718 65.8755 33.1718H69.1083L72.4911 36.5561C72.6659 36.7311 72.8887 36.8504 73.1314 36.8987C73.374 36.947 73.6254 36.9222 73.854 36.8275C74.0825 36.7328 74.2778 36.5725 74.4151 36.3667C74.5525 36.161 74.6257 35.9191 74.6255 35.6718V21.9218C74.6254 21.6745 74.5521 21.4329 74.4147 21.2273C74.2773 21.0218 74.082 20.8616 73.8536 20.7671ZM92.1255 14.4218V34.4218C92.1255 35.0848 91.8621 35.7207 91.3933 36.1895C90.9244 36.6584 90.2885 36.9218 89.6255 36.9218H84.6255C84.294 36.9218 83.976 36.7901 83.7416 36.5556C83.5072 36.3212 83.3755 36.0033 83.3755 35.6718C83.3755 35.3402 83.5072 35.0223 83.7416 34.7879C83.976 34.5535 84.294 34.4218 84.6255 34.4218H89.6255V15.6718H82.1255C81.794 15.6718 81.476 15.5401 81.2416 15.3056C81.0072 15.0712 80.8755 14.7533 80.8755 14.4218V6.92175H67.1255V19.4218C67.1255 19.7533 66.9938 20.0712 66.7594 20.3056C66.525 20.5401 66.207 20.6718 65.8755 20.6718C65.544 20.6718 65.226 20.5401 64.9916 20.3056C64.7572 20.0712 64.6255 19.7533 64.6255 19.4218V6.92175C64.6255 6.25871 64.8889 5.62283 65.3577 5.15399C65.8266 4.68515 66.4624 4.42175 67.1255 4.42175H82.1255C82.2897 4.42162 82.4523 4.45385 82.6041 4.51658C82.7558 4.57932 82.8937 4.67134 83.0099 4.78738L91.7599 13.5374C91.8759 13.6536 91.9679 13.7914 92.0307 13.9432C92.0934 14.0949 92.1256 14.2576 92.1255 14.4218ZM83.3755 13.1718H87.8583L83.3755 8.68894V13.1718Z"
						fill="var(--color-heading)"
					/>
					<path
						d="M101.054 31.7768L101.933 37.3326C102.361 40.0339 101.699 42.7946 100.091 45.0073C98.4833 47.22 96.0625 48.7035 93.3612 49.1313C90.6598 49.5592 87.8991 48.8964 85.6864 47.2888C83.4737 45.6812 81.9903 43.2604 81.5624 40.559L81.2691 38.7071C81.1913 38.2159 81.3118 37.714 81.6041 37.3117C81.8964 36.9094 82.3365 36.6397 82.8277 36.5619C83.3188 36.4841 83.8208 36.6046 84.2231 36.8969C84.6254 37.1892 84.8951 37.6293 84.9729 38.1205L85.1196 39.0464C85.1585 39.292 85.2933 39.5121 85.4945 39.6582C85.6956 39.8044 85.9466 39.8646 86.1922 39.8257C86.4378 39.7868 86.6578 39.652 86.804 39.4508C86.9501 39.2497 87.0104 38.9987 86.9715 38.7531L85.9449 32.2714C85.8671 31.7803 85.9876 31.2783 86.2799 30.876C86.5722 30.4737 87.0123 30.204 87.5035 30.1262C87.9946 30.0484 88.4966 30.1689 88.8989 30.4612C89.3012 30.7535 89.5709 31.1936 89.6487 31.6848L89.942 33.5367C89.9809 33.7823 90.1158 34.0023 90.3169 34.1485C90.5181 34.2946 90.7691 34.3549 91.0146 34.316C91.2602 34.2771 91.4803 34.1422 91.6264 33.9411C91.7726 33.7399 91.8328 33.489 91.7939 33.2434L91.5006 31.3915C91.4228 30.9003 91.5433 30.3984 91.8356 29.9961C92.1279 29.5937 92.5681 29.324 93.0592 29.2462C93.5504 29.1684 94.0523 29.289 94.4546 29.5812C94.857 29.8735 95.1267 30.3137 95.2045 30.8048L95.4978 32.6568C95.5367 32.9023 95.6715 33.1224 95.8727 33.2685C96.0738 33.4147 96.3248 33.4749 96.5704 33.4361C96.816 33.3972 97.036 33.2623 97.1822 33.0611C97.3283 32.86 97.3886 32.609 97.3497 32.3634C97.2719 31.8723 97.3924 31.3703 97.6847 30.968C97.977 30.5657 98.4171 30.296 98.9083 30.2182C99.3995 30.1404 99.9014 30.2609 100.304 30.5532C100.706 30.8455 100.976 31.2857 101.054 31.7768Z"
						fill="white"
					/>
					<path
						d="M97.3727 29.5123C96.8323 29.5971 96.3219 29.8166 95.8887 30.1507C95.6333 29.6471 95.2522 29.2179 94.7823 28.9047C94.3125 28.5914 93.7697 28.4048 93.2066 28.3627C92.6435 28.3206 92.079 28.4246 91.5678 28.6646C91.0567 28.9046 90.6161 29.2724 90.2887 29.7325C89.7653 29.344 89.138 29.1202 88.4868 29.0897C87.8357 29.0591 87.1902 29.2232 86.6327 29.561C86.0752 29.8988 85.6309 30.395 85.3566 30.9863C85.0822 31.5776 84.9902 32.2373 85.0923 32.8811L85.4589 35.196L84.07 35.416C83.2104 35.5521 82.4402 36.0241 81.9287 36.7281C81.4172 37.4322 81.2063 38.3106 81.3424 39.1701L81.5624 40.5591C81.9903 43.2604 83.4737 45.6812 85.6864 47.2888C87.8991 48.8964 90.6598 49.5592 93.3612 49.1314C96.0625 48.7035 98.4833 47.2201 100.091 45.0074C101.699 42.7947 102.361 40.034 101.933 37.3326L101.127 32.2398C100.991 31.3803 100.519 30.6101 99.8147 30.0985C99.1106 29.587 98.2322 29.3761 97.3727 29.5123ZM100.082 37.6259C100.432 39.8361 99.8893 42.0949 98.574 43.9053C97.2587 45.7157 95.2781 46.9294 93.0679 47.2794C90.8576 47.6295 88.5989 47.0872 86.7885 45.7719C84.9781 44.4566 83.7644 42.476 83.4143 40.2657L83.1943 38.8768C83.136 38.5084 83.2264 38.132 83.4456 37.8302C83.6648 37.5285 83.9949 37.3262 84.3633 37.2679L85.7522 37.0479L86.1922 39.8258C86.2311 40.0714 86.3659 40.2914 86.5671 40.4376C86.7683 40.5837 87.0192 40.644 87.2648 40.6051C87.5104 40.5662 87.7305 40.4313 87.8766 40.2302C88.0227 40.029 88.083 39.778 88.0441 39.5325L86.9442 32.5878C86.8858 32.2194 86.9762 31.8429 87.1954 31.5412C87.4147 31.2395 87.7448 31.0372 88.1131 30.9788C88.4815 30.9205 88.858 31.0109 89.1597 31.2301C89.4614 31.4493 89.6637 31.7794 89.722 32.1478L90.2354 35.3887C90.2742 35.6342 90.4091 35.8543 90.6103 36.0004C90.8114 36.1466 91.0624 36.2068 91.308 36.168C91.5535 36.1291 91.7736 35.9942 91.9198 35.793C92.0659 35.5919 92.1262 35.3409 92.0873 35.0953L91.574 31.8545C91.5156 31.4861 91.606 31.1097 91.8252 30.8079C92.0444 30.5062 92.3745 30.3039 92.7429 30.2456C93.1113 30.1872 93.4877 30.2776 93.7895 30.4968C94.0912 30.716 94.2935 31.0461 94.3518 31.4145L94.8651 34.6554C94.904 34.9009 95.0389 35.121 95.24 35.2672C95.4412 35.4133 95.6922 35.4736 95.9378 35.4347C96.1833 35.3958 96.4034 35.2609 96.5496 35.0598C96.6957 34.8586 96.756 34.6076 96.7171 34.3621L96.4971 32.9731C96.4387 32.6047 96.5291 32.2283 96.7483 31.9266C96.9675 31.6248 97.2977 31.4225 97.666 31.3642C98.0344 31.3058 98.4108 31.3962 98.7126 31.6154C99.0143 31.8347 99.2166 32.1648 99.2749 32.5331L100.082 37.6259Z"
						fill="var(--color-heading)"
					/>
					<path
						fill-rule="evenodd"
						clip-rule="evenodd"
						d="M133.241 4.6542C133.475 4.41978 133.793 4.28809 134.125 4.28809C134.456 4.28809 134.774 4.41978 135.008 4.6542C135.243 4.88862 135.375 5.20657 135.375 5.53809V35.5381C135.375 35.8696 135.243 36.1875 135.008 36.422C134.774 36.6564 134.456 36.7881 134.125 36.7881C133.793 36.7881 133.475 36.6564 133.241 36.422C133.006 36.1875 132.875 35.8696 132.875 35.5381V5.53809C132.875 5.20657 133.006 4.88862 133.241 4.6542ZM139.491 9.6542C139.725 9.41978 140.043 9.28809 140.375 9.28809C140.706 9.28809 141.024 9.41978 141.258 9.6542C141.493 9.88862 141.625 10.2066 141.625 10.5381V30.5381C141.625 30.8696 141.493 31.1875 141.258 31.422C141.024 31.6564 140.706 31.7881 140.375 31.7881C140.043 31.7881 139.725 31.6564 139.491 31.422C139.256 31.1875 139.125 30.8696 139.125 30.5381V10.5381C139.125 10.2066 139.256 9.88862 139.491 9.6542ZM145.741 14.6542C145.975 14.4198 146.293 14.2881 146.625 14.2881C146.956 14.2881 147.274 14.4198 147.508 14.6542C147.743 14.8886 147.875 15.2066 147.875 15.5381V25.5381C147.875 25.8696 147.743 26.1875 147.508 26.422C147.274 26.6564 146.956 26.7881 146.625 26.7881C146.293 26.7881 145.975 26.6564 145.741 26.422C145.506 26.1875 145.375 25.8696 145.375 25.5381V15.5381C145.375 15.2066 145.506 14.8886 145.741 14.6542ZM151.991 12.1542C152.225 11.9198 152.543 11.7881 152.875 11.7881C153.206 11.7881 153.524 11.9198 153.758 12.1542C153.993 12.3886 154.125 12.7066 154.125 13.0381V28.0381C154.125 28.3696 153.993 28.6875 153.758 28.922C153.524 29.1564 153.206 29.2881 152.875 29.2881C152.543 29.2881 152.225 29.1564 151.991 28.922C151.756 28.6875 151.625 28.3696 151.625 28.0381V13.0381C151.625 12.7066 151.756 12.3886 151.991 12.1542ZM126.125 26.0851V16.0851C126.125 15.7536 126.256 15.4356 126.491 15.2012C126.725 14.9668 127.043 14.8351 127.375 14.8351C127.706 14.8351 128.024 14.9668 128.258 15.2012C128.493 15.4356 128.625 15.7536 128.625 16.0851V26.0851C128.625 26.4166 128.493 26.7345 128.258 26.969C128.024 27.2034 127.706 27.3351 127.375 27.3351C127.043 27.3351 126.725 27.2034 126.491 26.969C126.256 26.7345 126.125 26.4166 126.125 26.0851ZM122.008 5.2012C121.774 4.96678 121.456 4.83508 121.125 4.83508C120.793 4.83508 120.475 4.96678 120.241 5.2012C120.006 5.43562 119.875 5.75356 119.875 6.08508V36.0851C119.875 36.4166 120.006 36.7345 120.241 36.969C120.475 37.2034 120.793 37.3351 121.125 37.3351C121.456 37.3351 121.774 37.2034 122.008 36.969C122.243 36.7345 122.375 36.4166 122.375 36.0851V6.08508C122.375 5.75356 122.243 5.43562 122.008 5.2012ZM115.758 10.2012C115.524 9.96678 115.206 9.83508 114.875 9.83508C114.543 9.83508 114.225 9.96678 113.991 10.2012C113.756 10.4356 113.625 10.7536 113.625 11.0851V31.0851C113.625 31.4166 113.756 31.7345 113.991 31.969C114.225 32.2034 114.543 32.3351 114.875 32.3351C115.206 32.3351 115.524 32.2034 115.758 31.969C115.993 31.7345 116.125 31.4166 116.125 31.0851V11.0851C116.125 10.7536 115.993 10.4356 115.758 10.2012ZM109.508 15.2012C109.274 14.9668 108.956 14.8351 108.625 14.8351C108.293 14.8351 107.975 14.9668 107.741 15.2012C107.506 15.4356 107.375 15.7536 107.375 16.0851V26.0851C107.375 26.4166 107.506 26.7345 107.741 26.969C107.975 27.2034 108.293 27.3351 108.625 27.3351C108.956 27.3351 109.274 27.2034 109.508 26.969C109.743 26.7345 109.875 26.4166 109.875 26.0851V16.0851C109.875 15.7536 109.743 15.4356 109.508 15.2012ZM103.258 12.7012C103.024 12.4668 102.706 12.3351 102.375 12.3351C102.043 12.3351 101.725 12.4668 101.491 12.7012C101.256 12.9356 101.125 13.2536 101.125 13.5851V28.5851C101.125 28.9166 101.256 29.2345 101.491 29.469C101.725 29.7034 102.043 29.8351 102.375 29.8351C102.706 29.8351 103.024 29.7034 103.258 29.469C103.493 29.2345 103.625 28.9166 103.625 28.5851V13.5851C103.625 13.2536 103.493 12.9356 103.258 12.7012Z"
						fill="var(--color-paragraph)"
					/>
				</svg>

				{#if isDragging}
					Drop the file here to upload!
				{:else}
					Drag a music file here or click the area to upload
				{/if}
			</span>
			{#if !isDragging}
				<span class="subtext" transition:slide>
					Any MP3, FLAC or WAV file under 3 MB or 10 minutes.
				</span>
			{/if}
			{#if error}
				<span class="error">
					{error}
				</span>
			{/if}
		</label>

		<!-- Otherwise, show the edit screen -->
	{:else}
		<div class="form">
			<TextInput
				name="title"
				label="Song title"
				placeholder="Name of the song"
				maxlength={80}
				bind:value={widgetTitle}
			/>
			<TextInput
				name="artist"
				label="Artist(s)"
				placeholder="Names of the contributing artists"
				maxlength={50}
				bind:value={widgetArtist}
			/>

			<h3>Preview</h3>

			<MusicWidgetComponent
				widget={{
					id: 'music',
					album_art_url: null,
					title: widgetTitle,
					artist: widgetArtist,
					content_url: widgetContentUrl,
					provider: 'local',
					external_url: null
				}}
				editing={false}
			/>

			<div class="buttons">
				<Button
					type="button"
					variant="secondary"
					onclick={() => {
						widgetContentUrl = null;
						widgetTitle = '';
						widgetArtist = '';
						widgetProvider = null;
						isNewMusic = true;
					}}
					disabled={isLoading}
				>
					{#if isNewMusic}
						Go back
					{:else}
						Replace music
					{/if}
				</Button>
				<Button
					type="submit"
					disabled={!widgetTitle ||
						!widgetArtist ||
						!widgetContentUrl ||
						isLoading ||
						(!isNewMusic && widgetTitle === widget.title && widgetArtist === widget.artist)}
				>
					{#if isNewMusic && isLoading}
						Uploading...
					{:else if isNewMusic && !isLoading}
						Upload music
					{:else if !isNewMusic && isLoading}
						Loading...
					{:else}
						Save changes
					{/if}
				</Button>
			</div>
		</div>
	{/if}
</form>

<style lang="scss">
	#audio-file-upload {
		display: none;
	}

	[for='audio-file-upload'] {
		display: flex;
		flex-direction: column;
		gap: calc(var(--base-gap) * 0.5);
		width: 100%;
		height: 100%;
		min-height: 250px;
		border: 3px dashed var(--widgets-background-color-dim);
		border-radius: var(--inputs-border-base-radius);
		align-items: center;
		justify-content: center;
		cursor: pointer;
		transition: border 1000ms;
		padding: calc(var(--base-padding) * 1.5);
		text-align: center;
		text-wrap: balance;

		.heading {
			display: flex;
			flex-direction: column;
			align-items: center;
			font-size: 1.25rem;
		}

		&.dragging {
			border: 3px solid var(--widgets-background-color-dim);
		}

		.error {
			color: var(--color-urgent);
		}
	}

	form {
		display: contents;
	}

	.form {
		display: flex;
		flex-direction: column;
		gap: calc(var(--base-gap) * 0.5);

		.buttons {
			display: flex;
			gap: calc(var(--base-gap) * 0.5);
			margin-top: var(--base-gap);
		}
	}
</style>
